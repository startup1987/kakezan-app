<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>„Åã„Åë„Åñ„Çì „Çå„Çì„Åó„ÇÖ„ÅÜ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Hiragino Sans', sans-serif; user-select: none; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .animate-bounce { animation: bounce 1s infinite; }
    </style>
</head>
<body class="bg-gradient-to-b from-cyan-100 to-blue-200 min-h-screen">
    <div id="app"></div>

    <script>
        // „Éá„Éº„ÇøÊßãÈÄ†
        const ANIMALS = [
            { id: 'cat', name: '„Éç„Ç≥', emoji: 'üê±', condition: '„ÅØ„Åò„ÇÅ„Å¶„ÅÆ10„ÇÇ„Çì' },
            { id: 'dog', name: '„Ç§„Éå', emoji: 'üê∂', condition: '„Åú„Çì„Å∂„Åõ„ÅÑ„Åã„ÅÑÔºÅ' },
            { id: 'rabbit', name: '„Ç¶„Çµ„ÇÆ', emoji: 'üê∞', condition: '5„ÇÇ„Çì„Çå„Çì„Åû„Åè' },
            { id: 'panda', name: '„Éë„É≥„ÉÄ', emoji: 'üêº', condition: '3„Åã„ÅÑ„Éó„É¨„Ç§' },
            { id: 'bear', name: '„ÇØ„Éû', emoji: 'üêª', condition: '„Å´„Åå„Å¶„Çí„Åõ„ÅÑ„Åã„ÅÑ' },
            { id: 'fox', name: '„Ç≠„ÉÑ„Éç', emoji: 'ü¶ä', condition: '20„ÇÇ„Çì„ÇØ„É™„Ç¢' },
            { id: 'lion', name: '„É©„Ç§„Ç™„É≥', emoji: 'ü¶Å', condition: '30„ÇÇ„Çì„ÇØ„É™„Ç¢' },
            { id: 'tiger', name: '„Éà„É©', emoji: 'üêØ', condition: '„Åò„Åì„Éô„Çπ„Éà„Åì„ÅÜ„Åó„Çì' },
            { id: 'koala', name: '„Ç≥„Ç¢„É©', emoji: 'üê®', condition: '2„Åã„Çå„Çì„Åû„Åè' },
            { id: 'pig', name: '„Éñ„Çø', emoji: 'üê∑', condition: '50„ÇÇ„Çì„Åõ„ÅÑ„Åã„ÅÑ' },
            { id: 'cow', name: '„Ç¶„Ç∑', emoji: 'üêÆ', condition: '100„ÇÇ„Çì„Åõ„ÅÑ„Åã„ÅÑ' },
            { id: 'monkey', name: '„Çµ„É´', emoji: 'üêµ', condition: '7„ÅÆ„Å†„Çì„Éû„Çπ„Çø„Éº' },
            { id: 'chicken', name: '„Éã„ÉØ„Éà„É™', emoji: 'üêî', condition: '5„Åã„Çå„Çì„Åû„Åè' },
            { id: 'penguin', name: '„Éö„É≥„ÇÆ„É≥', emoji: 'üêß', condition: '„Å≤„Å£„Åï„Çì„ÉÅ„É£„É¨„É≥„Ç∏' },
            { id: 'frog', name: '„Ç´„Ç®„É´', emoji: 'üê∏', condition: '10„ÇÇ„Çì10„Å≥„Çá„ÅÜ' },
            { id: 'turtle', name: '„Ç´„É°', emoji: 'üê¢', condition: '„Åò„Å£„Åè„Çä„Åå„Çì„Å∞„Å£„Åü' },
            { id: 'elephant', name: '„Çæ„Ç¶', emoji: 'üêò', condition: '200„ÇÇ„Çì„Åõ„ÅÑ„Åã„ÅÑ' },
            { id: 'giraffe', name: '„Ç≠„É™„É≥', emoji: 'ü¶í', condition: '8„ÅÆ„Å†„Çì„Éû„Çπ„Çø„Éº' },
            { id: 'zebra', name: '„Ç∑„Éû„Ç¶„Éû', emoji: 'ü¶ì', condition: '9„ÅÆ„Å†„Çì„Éû„Çπ„Çø„Éº' },
            { id: 'dolphin', name: '„Ç§„É´„Ç´', emoji: 'üê¨', condition: '„Åú„Çì„Å∂„Ç≥„É≥„Éó„É™„Éº„ÉàÔºÅ' },
        ];

        // „Ç¢„Éó„É™„ÅÆÁä∂ÊÖã
        let state = {
            screen: 'home',
            mode: 'kuku',
            questionCount: 10,
            questions: [],
            currentIndex: 0,
            answers: [],
            startTime: 0,
            input: '',
            feedback: '',
            attempts: 0,
            soundEnabled: true,
            userData: loadUserData()
        };

        // Èü≥Â£∞Ê©üËÉΩÔºàWeb Audio APIÔºâ
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        function playSound(frequency, duration, type = 'sine') {
            if (!state.soundEnabled) return;

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = frequency;
            oscillator.type = type;

            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        }

        function playCorrectSound() {
            // „Éî„É≠„É™„Éº„É≥‚ô™Ôºà‰∏äÊòáÈü≥Ôºâ
            playSound(523.25, 0.1); // „Éâ
            setTimeout(() => playSound(659.25, 0.1), 100); // „Éü
            setTimeout(() => playSound(783.99, 0.2), 200); // „ÇΩ
        }

        function playIncorrectSound() {
            // „Éñ„Éñ„ÉºÔºà‰∏ãÈôçÈü≥Ôºâ
            playSound(300, 0.15, 'sawtooth');
            setTimeout(() => playSound(200, 0.25, 'sawtooth'), 150);
        }

        function toggleSound() {
            state.soundEnabled = !state.soundEnabled;
            localStorage.setItem('kakezan-sound', state.soundEnabled);
            render();
        }

        function playAnimalSound(animalId) {
            if (!state.soundEnabled) return;

            // Èü≥Â£∞ÂêàÊàêAPI„Çí‰Ωø„Å£„Å¶ÂãïÁâ©„ÅÆÈ≥¥„ÅçÂ£∞„ÇíÂÜçÁîü
            const utterance = new SpeechSynthesisUtterance();

            // ÂêÑÂãïÁâ©„ÅÆÈ≥¥„ÅçÂ£∞
            const animalVoices = {
                cat: { text: '„Éã„É£„Éº„ÄÅ„Éã„É£„Éº', pitch: 1.5, rate: 1.0 },
                dog: { text: '„ÉØ„É≥„ÄÅ„ÉØ„É≥„ÄÅ„ÉØ„É≥', pitch: 0.8, rate: 1.1 },
                rabbit: { text: '„Éî„Éß„É≥„ÄÅ„Éî„Éß„É≥', pitch: 1.6, rate: 1.2 },
                panda: { text: '„ÇØ„Ç©„É≥„ÄÅ„ÇØ„Ç©„É≥', pitch: 1.0, rate: 0.9 },
                bear: { text: '„Ç∞„Ç™„Éº', pitch: 0.6, rate: 0.8 },
                fox: { text: '„Ç≥„É≥„ÄÅ„Ç≥„É≥„ÄÅ„Ç≥„É≥', pitch: 1.4, rate: 1.0 },
                lion: { text: '„Ç¨„Ç™„Éº', pitch: 0.5, rate: 0.7 },
                tiger: { text: '„Ç¶„Ç©„Éº', pitch: 0.6, rate: 0.8 },
                koala: { text: '„ÇØ„Ç•„ÄÅ„ÇØ„Ç•', pitch: 1.3, rate: 1.0 },
                pig: { text: '„Éñ„Éº„ÄÅ„Éñ„Éº„ÄÅ„Éñ„Éº', pitch: 1.0, rate: 1.0 },
                cow: { text: '„É¢„Éº„ÄÅ„É¢„Éº', pitch: 0.7, rate: 0.9 },
                monkey: { text: '„Ç≠„Éº„ÄÅ„Ç≠„Éº„ÄÅ„Ç≠„Éº', pitch: 1.7, rate: 1.3 },
                chicken: { text: '„Ç≥„Ç±„Ç≥„ÉÉ„Ç≥„Éº', pitch: 1.2, rate: 1.1 },
                penguin: { text: '„ÇØ„Çß„Éº„ÄÅ„ÇØ„Çß„Éº', pitch: 1.1, rate: 1.0 },
                frog: { text: '„Ç±„É≠„Ç±„É≠„ÄÅ„Ç±„É≠', pitch: 1.0, rate: 1.2 },
                turtle: { text: '„Éï„Éº', pitch: 0.9, rate: 0.7 },
                elephant: { text: '„Éë„Ç™„Éº„É≥', pitch: 0.5, rate: 0.8 },
                giraffe: { text: '„É≥„Éº', pitch: 1.0, rate: 0.9 },
                zebra: { text: '„Éí„Éí„Éº„É≥', pitch: 1.1, rate: 1.0 },
                dolphin: { text: '„Ç≠„É•„Éº„ÄÅ„Ç≠„É•„Éº„ÄÅ„Ç≠„É•„Éº', pitch: 1.8, rate: 1.2 }
            };

            if (animalVoices[animalId]) {
                const voice = animalVoices[animalId];
                utterance.text = voice.text;
                utterance.pitch = voice.pitch;
                utterance.rate = voice.rate;
                utterance.volume = 0.8;
                utterance.lang = 'ja-JP';

                window.speechSynthesis.cancel(); // Ââç„ÅÆÈü≥Â£∞„Çí„Ç≠„É£„É≥„Çª„É´
                window.speechSynthesis.speak(utterance);
            }
        }

        // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏
        function loadUserData() {
            const stored = localStorage.getItem('kakezan-data');
            const soundSetting = localStorage.getItem('kakezan-sound');
            if (soundSetting !== null) {
                state.soundEnabled = soundSetting === 'true';
            }
            if (stored) return JSON.parse(stored);
            return {
                animals: ANIMALS.map(a => ({ ...a, unlocked: false })),
                stats: {
                    totalSessions: 0,
                    totalQuestions: 0,
                    correctAnswers: 0,
                    incorrectAnswers: 0,
                    bestTime: 0,
                    bestAccuracy: 0,
                    wrongQuestions: [],
                    lastPlayedDate: '',
                    consecutiveDays: 0
                },
                sessions: []
            };
        }

        function saveUserData() {
            localStorage.setItem('kakezan-data', JSON.stringify(state.userData));
        }

        // ÂïèÈ°åÁîüÊàê
        function generateQuestions(mode, count) {
            const questions = [];
            for (let i = 0; i < count; i++) {
                if (mode === 'kuku') {
                    const num1 = Math.floor(Math.random() * 9) + 1;
                    const num2 = Math.floor(Math.random() * 9) + 1;
                    questions.push({ num1, num2, answer: num1 * num2 });
                } else {
                    const num1 = Math.floor(Math.random() * 90) + 10;
                    const num2 = Math.floor(Math.random() * 9) + 1;
                    questions.push({ num1, num2, answer: num1 * num2 });
                }
            }
            return questions;
        }

        // Âä±„Åæ„Åó„É°„ÉÉ„Çª„Éº„Ç∏
        function getEncouragement(isCorrect) {
            if (isCorrect) {
                const msgs = ['„ÅÑ„ÅÑ„Å≠ÔºÅ', '„Åô„Åî„ÅÑÔºÅ', '„Åõ„ÅÑ„Åã„ÅÑÔºÅ', '„ÇÑ„Å£„Åü„Å≠ÔºÅ', '„ÅØ„ÇÑ„ÅÑÔºÅ', '„Éê„ÉÉ„ÉÅ„É™ÔºÅ', '„Åï„Åô„ÅåÔºÅ'];
                return msgs[Math.floor(Math.random() * msgs.length)];
            }
            return ['„Å§„Åé„ÅÑ„Åì„ÅÜÔºÅ', '„Åä„Åó„ÅÑÔºÅ', '„Åå„Çì„Å∞„Çç„ÅÜÔºÅ'][Math.floor(Math.random() * 3)];
        }

        // ÊôÇÈñì„Éï„Ç©„Éº„Éû„ÉÉ„Éà
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return mins > 0 ? `${mins}ÂàÜ${secs}Áßí` : `${secs}Áßí`;
        }

        // „ÇØ„Ç§„Ç∫ÈñãÂßã
        function startQuiz(mode, count) {
            state.mode = mode;
            state.questionCount = count;
            state.questions = generateQuestions(mode, count);
            state.currentIndex = 0;
            state.answers = Array(count).fill(null);
            state.startTime = Date.now();
            state.input = '';
            state.feedback = '';
            state.attempts = 0;
            state.screen = 'quiz';
            render();
        }

        // ÂõûÁ≠îÂá¶ÁêÜ
        function handleAnswer(value) {
            const q = state.questions[state.currentIndex];
            const isCorrect = value === q.answer;

            if (isCorrect) {
                playCorrectSound(); // Ê≠£Ëß£Èü≥„ÇíÈ≥¥„Çâ„Åô
                state.feedback = getEncouragement(true);
                state.answers[state.currentIndex] = value;
                setTimeout(() => {
                    state.feedback = '';
                    state.input = '';
                    state.attempts = 0;
                    if (state.currentIndex < state.questions.length - 1) {
                        state.currentIndex++;
                        render();
                    } else {
                        completeQuiz();
                    }
                }, 1000);
            } else {
                playIncorrectSound(); // ‰∏çÊ≠£Ëß£Èü≥„ÇíÈ≥¥„Çâ„Åô
                state.feedback = getEncouragement(false);
                state.attempts++;
                if (state.attempts >= 3) {
                    state.answers[state.currentIndex] = null;
                    setTimeout(() => {
                        state.feedback = '';
                        state.input = '';
                        state.attempts = 0;
                        if (state.currentIndex < state.questions.length - 1) {
                            state.currentIndex++;
                            render();
                        } else {
                            completeQuiz();
                        }
                    }, 1500);
                } else {
                    setTimeout(() => {
                        state.feedback = '';
                        state.input = '';
                        render();
                    }, 1000);
                }
            }
            render();
        }

        // „ÇØ„Ç§„Ç∫ÂÆå‰∫Ü
        function completeQuiz() {
            const endTime = Date.now();
            const correctCount = state.answers.filter((a, i) => a === state.questions[i].answer).length;
            const totalTime = Math.floor((endTime - state.startTime) / 1000);
            const accuracy = Math.round((correctCount / state.questions.length) * 100);

            // Áµ±Ë®àÊõ¥Êñ∞
            const today = new Date().toDateString();
            let consecutiveDays = state.userData.stats.consecutiveDays;
            if (state.userData.stats.lastPlayedDate !== today) {
                const lastDate = new Date(state.userData.stats.lastPlayedDate);
                const todayDate = new Date(today);
                const diffDays = Math.floor((todayDate - lastDate) / (1000 * 60 * 60 * 24));
                if (diffDays === 1) {
                    consecutiveDays++;
                } else if (diffDays > 1 || !state.userData.stats.lastPlayedDate) {
                    consecutiveDays = 1;
                }
            }

            const wrongQuestions = state.questions.filter((q, i) => state.answers[i] !== q.answer);

            state.userData.stats = {
                totalSessions: state.userData.stats.totalSessions + 1,
                totalQuestions: state.userData.stats.totalQuestions + state.questions.length,
                correctAnswers: state.userData.stats.correctAnswers + correctCount,
                incorrectAnswers: state.userData.stats.incorrectAnswers + (state.questions.length - correctCount),
                bestTime: state.userData.stats.bestTime === 0 || totalTime < state.userData.stats.bestTime ? totalTime : state.userData.stats.bestTime,
                bestAccuracy: Math.max(state.userData.stats.bestAccuracy, accuracy),
                wrongQuestions: [...state.userData.stats.wrongQuestions, ...wrongQuestions].slice(-50),
                lastPlayedDate: today,
                consecutiveDays
            };

            // ÂãïÁâ©„Ç´„Éº„ÉâËß£Êîæ
            const newAnimals = checkUnlockAnimals(correctCount, accuracy);

            saveUserData();
            state.screen = 'result';
            state.newAnimals = newAnimals;
            state.endTime = endTime;
            render();
        }

        // ÂãïÁâ©„Ç´„Éº„ÉâËß£Êîæ„ÉÅ„Çß„ÉÉ„ÇØ
        function checkUnlockAnimals(correctCount, accuracy) {
            const newUnlocked = [];
            const stats = state.userData.stats;

            const conditions = {
                cat: stats.totalSessions >= 1,
                dog: correctCount === state.questions.length,
                rabbit: hasConsecutiveCorrect(5),
                panda: stats.totalSessions >= 3,
                fox: state.questions.length >= 20 && correctCount >= 18,
                lion: state.questions.length >= 30 && correctCount >= 27,
                koala: stats.consecutiveDays >= 2,
                pig: stats.correctAnswers >= 50,
                cow: stats.correctAnswers >= 100,
                chicken: stats.consecutiveDays >= 5
            };

            state.userData.animals = state.userData.animals.map(animal => {
                if (!animal.unlocked && conditions[animal.id]) {
                    newUnlocked.push(animal.emoji);
                    return { ...animal, unlocked: true, unlockedAt: Date.now() };
                }
                return animal;
            });

            return newUnlocked;
        }

        function hasConsecutiveCorrect(count) {
            let consecutive = 0;
            for (let i = 0; i < state.answers.length; i++) {
                if (state.answers[i] === state.questions[i].answer) {
                    consecutive++;
                    if (consecutive >= count) return true;
                } else {
                    consecutive = 0;
                }
            }
            return false;
        }

        // Êï∞Â≠ó„Éë„ÉÉ„Éâ
        function NumberPad() {
            return `
                <div class="w-full max-w-md mx-auto">
                    <div class="bg-white border-4 border-gray-300 rounded-2xl p-6 mb-4 min-h-[80px] flex items-center justify-center">
                        <span class="text-5xl font-bold text-gray-800">${state.input || '?'}</span>
                    </div>
                    <div class="grid grid-cols-3 gap-3 mb-3">
                        ${[1,2,3,4,5,6,7,8,9].map(n => `
                            <button onclick="addDigit(${n})" class="bg-blue-500 hover:bg-blue-600 active:bg-blue-700 text-white text-4xl font-bold rounded-xl h-20">
                                ${n}
                            </button>
                        `).join('')}
                    </div>
                    <div class="grid grid-cols-3 gap-3">
                        <button onclick="deleteDigit()" class="bg-gray-400 hover:bg-gray-500 active:bg-gray-600 text-white text-2xl font-bold rounded-xl h-20">‚å´</button>
                        <button onclick="addDigit(0)" class="bg-blue-500 hover:bg-blue-600 active:bg-blue-700 text-white text-4xl font-bold rounded-xl h-20">0</button>
                        <button onclick="submitAnswer()" ${!state.input ? 'disabled' : ''} class="${state.input ? 'bg-green-500 hover:bg-green-600 active:bg-green-700' : 'bg-gray-300'} text-white text-2xl font-bold rounded-xl h-20">„Åë„Å£„Å¶„ÅÑ</button>
                    </div>
                </div>
            `;
        }

        function addDigit(n) {
            if (state.input.length < 4) {
                state.input += n;
                render();
            }
        }

        function deleteDigit() {
            state.input = state.input.slice(0, -1);
            render();
        }

        function submitAnswer() {
            if (state.input) {
                handleAnswer(parseInt(state.input));
            }
        }

        // ÁîªÈù¢„É¨„É≥„ÉÄ„É™„É≥„Ç∞
        function render() {
            const app = document.getElementById('app');

            if (state.screen === 'home') {
                app.innerHTML = HomeScreen();
            } else if (state.screen === 'quiz') {
                app.innerHTML = QuizScreen();
            } else if (state.screen === 'result') {
                app.innerHTML = ResultScreen();
            } else if (state.screen === 'collection') {
                app.innerHTML = CollectionScreen();
            } else if (state.screen === 'stats') {
                app.innerHTML = StatsScreen();
            }
        }

        function HomeScreen() {
            const unlockedCount = state.userData.animals.filter(a => a.unlocked).length;
            const totalAccuracy = state.userData.stats.totalQuestions > 0
                ? Math.round((state.userData.stats.correctAnswers / state.userData.stats.totalQuestions) * 100)
                : 0;

            return `
                <div class="max-w-2xl mx-auto p-4">
                    <h1 class="text-5xl font-bold text-center mb-4 text-gray-800 mt-8">„Åã„Åë„Åñ„Çì „Çå„Çì„Åó„ÇÖ„ÅÜ</h1>
                    <div class="text-center text-xl text-gray-600 mb-8">„Åü„ÅÆ„Åó„Åè „Åæ„Å™„Åº„ÅÜÔºÅ</div>

                    <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                        <div class="grid grid-cols-3 gap-4 text-center">
                            <div>
                                <div class="text-3xl font-bold text-blue-600">${unlockedCount}</div>
                                <div class="text-sm text-gray-600">„Å©„ÅÜ„Å∂„Å§</div>
                            </div>
                            <div>
                                <div class="text-3xl font-bold text-green-600">${totalAccuracy}%</div>
                                <div class="text-sm text-gray-600">„Åõ„ÅÑ„Åã„ÅÑ„Çä„Å§</div>
                            </div>
                            <div>
                                <div class="text-3xl font-bold text-orange-600">${state.userData.stats.consecutiveDays}</div>
                                <div class="text-sm text-gray-600">„Çå„Çì„Åû„Åè</div>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-4 mb-6">
                        <div class="bg-white rounded-2xl shadow-lg p-6">
                            <h2 class="text-2xl font-bold mb-4 text-gray-800">‰πù‰πù„Çπ„Éî„Éº„Éâ„Çå„Çì„Åó„ÇÖ„ÅÜ</h2>
                            <div class="grid grid-cols-3 gap-3">
                                <button onclick="startQuiz('kuku', 10)" class="bg-blue-500 hover:bg-blue-600 text-white text-xl font-bold py-4 rounded-xl">10„ÇÇ„Çì</button>
                                <button onclick="startQuiz('kuku', 20)" class="bg-blue-500 hover:bg-blue-600 text-white text-xl font-bold py-4 rounded-xl">20„ÇÇ„Çì</button>
                                <button onclick="startQuiz('kuku', 30)" class="bg-blue-500 hover:bg-blue-600 text-white text-xl font-bold py-4 rounded-xl">30„ÇÇ„Çì</button>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl shadow-lg p-6">
                            <h2 class="text-2xl font-bold mb-4 text-gray-800">„Å≤„Å£„Åï„Çì„ÉÅ„É£„É¨„É≥„Ç∏</h2>
                            <div class="grid grid-cols-3 gap-3">
                                <button onclick="startQuiz('hissan', 10)" class="bg-purple-500 hover:bg-purple-600 text-white text-xl font-bold py-4 rounded-xl">10„ÇÇ„Çì</button>
                                <button onclick="startQuiz('hissan', 20)" class="bg-purple-500 hover:bg-purple-600 text-white text-xl font-bold py-4 rounded-xl">20„ÇÇ„Çì</button>
                                <button onclick="startQuiz('hissan', 30)" class="bg-purple-500 hover:bg-purple-600 text-white text-xl font-bold py-4 rounded-xl">30„ÇÇ„Çì</button>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <button onclick="goToCollection()" class="bg-green-500 hover:bg-green-600 text-white text-xl font-bold py-6 rounded-xl">üêæ „Ç≥„É¨„ÇØ„Ç∑„Éß„É≥</button>
                        <button onclick="goToStats()" class="bg-yellow-500 hover:bg-yellow-600 text-white text-xl font-bold py-6 rounded-xl">üìä „Åç„Çç„Åè</button>
                    </div>

                    <div class="bg-white rounded-2xl shadow-lg p-4">
                        <button onclick="toggleSound()" class="w-full flex items-center justify-between text-lg font-bold text-gray-800">
                            <span>„Åä„Å®„Ç®„Éï„Çß„ÇØ„Éà</span>
                            <span class="text-2xl">${state.soundEnabled ? 'üîä ON' : 'üîá OFF'}</span>
                        </button>
                    </div>
                </div>
            `;
        }

        function QuizScreen() {
            const q = state.questions[state.currentIndex];
            const progress = state.currentIndex + 1;
            const progressPercent = (progress / state.questionCount) * 100;

            return `
                <div class="min-h-screen bg-gradient-to-b from-blue-100 to-purple-100 p-4">
                    <div class="max-w-2xl mx-auto">
                        <div class="flex justify-between items-center mb-6">
                            <button onclick="goHome()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl text-lg font-bold">‚óÄ „ÇÇ„Å©„Çã</button>
                            <div class="text-2xl font-bold text-gray-800">${progress} / ${state.questionCount}</div>
                        </div>

                        <div class="bg-white rounded-full h-4 mb-8 overflow-hidden">
                            <div class="bg-green-500 h-full transition-all duration-500" style="width: ${progressPercent}%"></div>
                        </div>

                        <div class="bg-white rounded-3xl shadow-xl p-8 mb-6">
                            <div class="text-center mb-8">
                                <div class="text-7xl font-bold text-gray-800 mb-4">${q.num1} √ó ${q.num2}</div>
                                <div class="text-4xl text-gray-600">= ?</div>
                            </div>

                            ${state.feedback ? `
                                <div class="text-center text-3xl font-bold mb-4 ${state.feedback.includes('„ÅÑ„ÅÑ„Å≠') || state.feedback.includes('„Åô„Åî„ÅÑ') || state.feedback.includes('„Åõ„ÅÑ„Åã„ÅÑ') || state.feedback.includes('„ÇÑ„Å£„Åü') || state.feedback.includes('„ÅØ„ÇÑ„ÅÑ') || state.feedback.includes('„Éê„ÉÉ„ÉÅ„É™') || state.feedback.includes('„Åï„Åô„Åå') ? 'text-green-600' : 'text-orange-600'}">
                                    ${state.feedback}
                                </div>
                            ` : NumberPad()}
                        </div>
                    </div>
                </div>
            `;
        }

        function ResultScreen() {
            const correctCount = state.answers.filter((a, i) => a === state.questions[i].answer).length;
            const totalTime = Math.floor((state.endTime - state.startTime) / 1000);
            const accuracy = Math.round((correctCount / state.questions.length) * 100);

            return `
                <div class="min-h-screen bg-gradient-to-b from-yellow-100 to-orange-100 p-4">
                    <div class="max-w-2xl mx-auto">
                        <div class="bg-white rounded-3xl shadow-xl p-8 mb-6">
                            <h1 class="text-4xl font-bold text-center mb-8 text-gray-800">„Åä„Å§„Åã„Çå„Åï„ÅæÔºÅ</h1>

                            <div class="grid grid-cols-3 gap-4 mb-8">
                                <div class="bg-blue-100 rounded-2xl p-6 text-center">
                                    <div class="text-5xl font-bold text-blue-600 mb-2">${correctCount}</div>
                                    <div class="text-lg text-gray-700">„Åõ„ÅÑ„Åã„ÅÑ</div>
                                </div>
                                <div class="bg-green-100 rounded-2xl p-6 text-center">
                                    <div class="text-5xl font-bold text-green-600 mb-2">${accuracy}%</div>
                                    <div class="text-lg text-gray-700">„Åõ„ÅÑ„Åã„ÅÑ„Çä„Å§</div>
                                </div>
                                <div class="bg-purple-100 rounded-2xl p-6 text-center">
                                    <div class="text-4xl font-bold text-purple-600 mb-2">${formatTime(totalTime)}</div>
                                    <div class="text-lg text-gray-700">„Çø„Ç§„É†</div>
                                </div>
                            </div>

                            ${state.newAnimals && state.newAnimals.length > 0 ? `
                                <div class="bg-gradient-to-r from-pink-100 to-yellow-100 rounded-2xl p-6 mb-6">
                                    <div class="text-2xl font-bold text-center mb-4 text-gray-800">üéâ „ÅÇ„Åü„Çâ„Åó„ÅÑ„Ç´„Éº„Éâ„Çí„Ç≤„ÉÉ„ÉàÔºÅ</div>
                                    <div class="flex justify-center gap-4 flex-wrap">
                                        ${state.newAnimals.map(emoji => `<div class="text-6xl animate-bounce">${emoji}</div>`).join('')}
                                    </div>
                                </div>
                            ` : ''}

                            <div class="text-center mb-6">
                                <p class="text-2xl text-gray-700">
                                    ${accuracy === 100 ? '„Åã„Çì„Å∫„ÅçÔºÅ„Åô„Åî„ÅÑ„ÅûÔºÅ' : accuracy >= 80 ? '„Çà„Åè„Åå„Çì„Å∞„Å£„Åü„Å≠ÔºÅ' : accuracy >= 60 ? '„ÅÑ„ÅÑ„Å°„Çá„ÅÜ„ÅóÔºÅ„Å§„Å•„Åë„Çà„ÅÜÔºÅ' : '„Å§„Åé„ÅØ„ÇÇ„Å£„Å®„Çà„Åè„Å™„Çã„ÇàÔºÅ'}
                                </p>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <button onclick="startQuiz('${state.mode}', ${state.questionCount})" class="bg-blue-500 hover:bg-blue-600 text-white text-2xl font-bold py-4 rounded-xl">„ÇÇ„ÅÜ„ÅÑ„Å°„Å©</button>
                                <button onclick="goHome()" class="bg-green-500 hover:bg-green-600 text-white text-2xl font-bold py-4 rounded-xl">„Éõ„Éº„É†„Å∏</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function CollectionScreen() {
            const unlockedCount = state.userData.animals.filter(a => a.unlocked).length;

            return `
                <div class="min-h-screen bg-gradient-to-b from-green-100 to-blue-100 p-4">
                    <div class="max-w-4xl mx-auto">
                        <div class="flex justify-between items-center mb-6">
                            <button onclick="goHome()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl text-lg font-bold">‚óÄ „ÇÇ„Å©„Çã</button>
                            <div class="text-2xl font-bold text-gray-800">${unlockedCount} / ${state.userData.animals.length}</div>
                        </div>

                        <h1 class="text-4xl font-bold text-center mb-8 text-gray-800">„Å©„ÅÜ„Å∂„Å§„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥</h1>

                        <div class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                            ${state.userData.animals.map(animal => `
                                <div onclick="${animal.unlocked ? `playAnimalSound('${animal.id}')` : ''}" class="${animal.unlocked ? 'bg-white cursor-pointer' : 'bg-gray-300'} rounded-2xl p-4 shadow-lg transition-transform ${animal.unlocked ? 'hover:scale-110 active:scale-95' : ''}">
                                    <div class="text-6xl text-center mb-2">${animal.unlocked ? animal.emoji : '‚ùì'}</div>
                                    <div class="text-center">
                                        <div class="text-lg font-bold mb-1 ${animal.unlocked ? 'text-gray-800' : 'text-gray-500'}">${animal.unlocked ? animal.name : '???'}</div>
                                        <div class="text-xs ${animal.unlocked ? 'text-gray-600' : 'text-gray-400'}">${animal.condition}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>

                        ${unlockedCount < state.userData.animals.length ? `
                            <div class="mt-8 bg-white rounded-2xl p-6 text-center">
                                <p class="text-xl text-gray-700">„Çå„Çì„Åó„ÇÖ„ÅÜ„Çí„Å§„Å•„Åë„Å¶„ÄÅ„Åô„Åπ„Å¶„ÅÆ„Å©„ÅÜ„Å∂„Å§„Çí„ÅÇ„Å§„ÇÅ„Çà„ÅÜÔºÅ</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function StatsScreen() {
            const stats = state.userData.stats;
            const totalAccuracy = stats.totalQuestions > 0 ? Math.round((stats.correctAnswers / stats.totalQuestions) * 100) : 0;

            const weakTables = {};
            stats.wrongQuestions.forEach(q => {
                if (q.num1 <= 9 && q.num2 <= 9) {
                    weakTables[q.num2] = (weakTables[q.num2] || 0) + 1;
                }
            });
            const topWeak = Object.entries(weakTables).sort((a, b) => b[1] - a[1]).slice(0, 3);

            return `
                <div class="min-h-screen bg-gradient-to-b from-purple-100 to-pink-100 p-4">
                    <div class="max-w-2xl mx-auto">
                        <div class="mb-6">
                            <button onclick="goHome()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl text-lg font-bold">‚óÄ „ÇÇ„Å©„Çã</button>
                        </div>

                        <h1 class="text-4xl font-bold text-center mb-8 text-gray-800">„Åç„Çç„Åè</h1>

                        <div class="bg-white rounded-3xl shadow-xl p-6 mb-6">
                            <h2 class="text-2xl font-bold mb-4 text-gray-800">„Åå„Çì„Å∞„Çä„Åç„Çç„Åè</h2>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-blue-50 rounded-xl p-4">
                                    <div class="text-sm text-gray-600 mb-1">„Åú„Çì„Å∂„ÅÆ„ÇÇ„Çì„Å†„ÅÑ</div>
                                    <div class="text-3xl font-bold text-blue-600">${stats.totalQuestions}</div>
                                </div>
                                <div class="bg-green-50 rounded-xl p-4">
                                    <div class="text-sm text-gray-600 mb-1">„Åõ„ÅÑ„Åã„ÅÑ„Çä„Å§</div>
                                    <div class="text-3xl font-bold text-green-600">${totalAccuracy}%</div>
                                </div>
                                <div class="bg-purple-50 rounded-xl p-4">
                                    <div class="text-sm text-gray-600 mb-1">„Éó„É¨„Ç§„Åã„ÅÑ„Åô„ÅÜ</div>
                                    <div class="text-3xl font-bold text-purple-600">${stats.totalSessions}</div>
                                </div>
                                <div class="bg-orange-50 rounded-xl p-4">
                                    <div class="text-sm text-gray-600 mb-1">„Çå„Çì„Åû„Åè„Å´„Å£„Åô„ÅÜ</div>
                                    <div class="text-3xl font-bold text-orange-600">${stats.consecutiveDays}</div>
                                </div>
                            </div>
                        </div>

                        ${stats.bestTime > 0 ? `
                            <div class="bg-white rounded-3xl shadow-xl p-6 mb-6">
                                <h2 class="text-2xl font-bold mb-4 text-gray-800">„Éô„Çπ„Éà„Åç„Çç„Åè</h2>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="bg-yellow-50 rounded-xl p-4">
                                        <div class="text-sm text-gray-600 mb-1">„Åï„ÅÑ„Åì„ÅÜ„Åõ„ÅÑ„Åã„ÅÑ„Çä„Å§</div>
                                        <div class="text-3xl font-bold text-yellow-600">${stats.bestAccuracy}%</div>
                                    </div>
                                    <div class="bg-pink-50 rounded-xl p-4">
                                        <div class="text-sm text-gray-600 mb-1">„Åï„ÅÑ„Åü„Çì„Çø„Ç§„É†</div>
                                        <div class="text-2xl font-bold text-pink-600">${formatTime(stats.bestTime)}</div>
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        ${topWeak.length > 0 ? `
                            <div class="bg-white rounded-3xl shadow-xl p-6 mb-6">
                                <h2 class="text-2xl font-bold mb-4 text-gray-800">„Å´„Åå„Å¶„Å™„Å†„Çì</h2>
                                <div class="space-y-3">
                                    ${topWeak.map(([table, count]) => `
                                        <div class="bg-red-50 rounded-xl p-4 flex justify-between items-center">
                                            <span class="text-xl font-bold text-gray-800">${table}„ÅÆ„Å†„Çì</span>
                                            <span class="text-lg text-gray-600">„Åæ„Å°„Åå„ÅÑ ${count}„Åã„ÅÑ</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥
        function goHome() {
            state.screen = 'home';
            render();
        }

        function goToCollection() {
            state.screen = 'collection';
            render();
        }

        function goToStats() {
            state.screen = 'stats';
            render();
        }

        // ÂàùÂõû„É¨„É≥„ÉÄ„É™„É≥„Ç∞
        render();
    </script>
</body>
</html>
